<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teaching Canvas</title>

<style>
  body {
    margin: 0;
    background: #1e1e1e;
    font-family: sans-serif;
    color: white;
  }

  #toolbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: #2b2b2b;
    padding: 8px;
    display: flex;
    gap: 8px;
    z-index: 10;
  }

  button, input {
    padding: 6px;
    cursor: pointer;
  }

  button.active {
    outline: 2px solid yellow;
  }

  #canvas-container {
    margin-top: 60px;
    height: calc(100vh - 60px);
    overflow-y: scroll;
  }

  canvas {
    background: white;
    display: block;
    margin: auto;
  }

  textarea {
    resize: none;
    outline: none;
  }
</style>
</head>

<body>

<div id="toolbar">
  <button id="penBtn" class="active">Pen</button>
  <button id="eraserBtn">Eraser</button>
  <button id="lineBtn">Line</button>
  <button id="rectBtn">Rect</button>
  <button id="circleBtn">Circle</button>
  <button id="selectBtn">Select</button>
  <input type="color" id="colorPicker" value="#000000">
  <input type="range" id="sizePicker" min="1" max="12" value="3">

  <button id="exportBtn">Export PDF</button>
</div>

<div id="canvas-container">
  <canvas id="canvas" width="1200" height="10000"></canvas>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

ctx.lineCap = "round";
ctx.lineJoin = "round";

let tool = "pen";
let drawing = false;
let startX, startY;
let lastX = 0, lastY = 0;
let pointerType = "mouse";

/* =========================
   UNDO / REDO
========================= */
const undoStack = [];
const redoStack = [];
const MAX_HISTORY = 50;

function saveState() {
  if (undoStack.length >= MAX_HISTORY) undoStack.shift();
  undoStack.push(canvas.toDataURL());
  redoStack.length = 0;
}

function restore(from, to) {
  if (!from.length) return;
  to.push(canvas.toDataURL());

  const img = new Image();
  img.src = from.pop();
  img.onload = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0);
  };
}

document.addEventListener("keydown", e => {
  if (e.ctrlKey && e.key === "z") {
    e.preventDefault();
    restore(undoStack, redoStack);
  }
  if (e.ctrlKey && e.key === "y") {
    e.preventDefault();
    restore(redoStack, undoStack);
  }
});

saveState();

/* =========================
   TOOL SELECTION
========================= */
function setTool(name, btn) {
  tool = name;
  document.querySelectorAll("#toolbar button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
}

penBtn.onclick = () => setTool("pen", penBtn);
eraserBtn.onclick = () => setTool("eraser", eraserBtn);
lineBtn.onclick = () => setTool("line", lineBtn);
rectBtn.onclick = () => setTool("rect", rectBtn);
circleBtn.onclick = () => setTool("circle", circleBtn);
selectBtn.onclick = () => setTool("select", selectBtn);

/* =========================
   SELECTION STATE
========================= */
let selection = null;
let selectionImage = null;
let draggingSelection = false;

/* =========================
   POINTER EVENTS
========================= */
canvas.addEventListener("pointerdown", e => {
  startX = lastX = e.offsetX;
  startY = lastY = e.offsetY;
  pointerType = e.pointerType;

  if (tool === "select" && selection &&
      e.offsetX > selection.x &&
      e.offsetX < selection.x + selection.w &&
      e.offsetY > selection.y &&
      e.offsetY < selection.y + selection.h) {
    draggingSelection = true;
    return;
  }

  drawing = true;
  ctx.beginPath();
  ctx.moveTo(startX, startY);
});

canvas.addEventListener("pointermove", e => {
  if (tool === "select" && drawing) {
    redraw();
    drawSelectionBox(startX, startY, e.offsetX - startX, e.offsetY - startY);
    return;
  }

  if (draggingSelection) {
    redraw();
    selection.x = e.offsetX - selection.w / 2;
    selection.y = e.offsetY - selection.h / 2;
    ctx.putImageData(selectionImage, selection.x, selection.y);
    drawSelectionOutline();
    return;
  }

  if (!drawing) return;

  const pressure = e.pressure || 0.5;
  const size = sizePicker.value;
  ctx.lineWidth = size * (pointerType === "pen" ? pressure * 2 : 1);

  if (tool === "pen") {
    ctx.strokeStyle = colorPicker.value;
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
  }

  if (tool === "eraser") {
    ctx.globalCompositeOperation = "destination-out";
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
    ctx.globalCompositeOperation = "source-over";
  }

  lastX = e.offsetX;
  lastY = e.offsetY;
});

canvas.addEventListener("pointerup", e => {
  if (tool === "select" && drawing) {
    drawing = false;
    const w = e.offsetX - startX;
    const h = e.offsetY - startY;

    selection = {
      x: Math.min(startX, e.offsetX),
      y: Math.min(startY, e.offsetY),
      w: Math.abs(w),
      h: Math.abs(h)
    };

    selectionImage = ctx.getImageData(selection.x, selection.y, selection.w, selection.h);
    ctx.clearRect(selection.x, selection.y, selection.w, selection.h);
    redraw();
    ctx.putImageData(selectionImage, selection.x, selection.y);
    drawSelectionOutline();
    saveState();
    return;
  }

  if (draggingSelection) {
    draggingSelection = false;
    saveState();
    return;
  }

  drawing = false;

  if (tool === "line") {
    ctx.beginPath();
    ctx.moveTo(startX, startY);
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
  }

  if (tool === "rect") {
    ctx.strokeRect(startX, startY, e.offsetX - startX, e.offsetY - startY);
  }

  if (tool === "circle") {
    const r = Math.hypot(e.offsetX - startX, e.offsetY - startY);
    ctx.beginPath();
    ctx.arc(startX, startY, r, 0, Math.PI * 2);
    ctx.stroke();
  }

  saveState();
});

/* =========================
   DELETE SELECTION
========================= */
document.addEventListener("keydown", e => {
  if (e.key === "Delete" && selection) {
    redraw();
    selection = null;
    selectionImage = null;
    saveState();
  }
});

/* =========================
   HELPERS
========================= */
function redraw() {
  const img = new Image();
  img.src = undoStack[undoStack.length - 1];
  img.onload = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0);
  };
}

function drawSelectionBox(x, y, w, h) {
  ctx.setLineDash([6, 4]);
  ctx.strokeStyle = "blue";
  ctx.strokeRect(x, y, w, h);
  ctx.setLineDash([]);
}

function drawSelectionOutline() {
  drawSelectionBox(selection.x, selection.y, selection.w, selection.h);
}
</script>


</body>
</html>
