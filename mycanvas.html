<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teaching Canvas - Pro Stylus + Transform</title>
<style>
  body { margin: 0; background: #1e1e1e; font-family: sans-serif; color: white; }
  #toolbar {
    position: fixed; top: 0; left: 0; right: 0;
    background: #2b2b2b; padding: 8px; display: flex; gap: 8px; z-index: 100;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5); align-items: center;
  }
  @media print {
    #toolbar, #textInput { display: none !important; }
    body { background: white; }
    #canvas-container { margin: 0; height: auto; }
    canvas { box-shadow: none; margin: 0; border: none; }
  }
  button, input { padding: 6px 12px; cursor: pointer; border: none; border-radius: 4px; background: #444; color: white; font-weight: bold; }
  button.active { background: #007bff; outline: 2px solid yellow; }
  #canvas-container { margin-top: 60px; padding-bottom: 50px; background: #333; min-height: 100vh; }
  canvas { background: white; display: block; margin: 0 auto; cursor: crosshair; touch-action: none; }
  #textInput { position: absolute; display: none; background: white; border: 1px solid #007bff; color: black; outline: none; z-index: 1000; padding: 2px; }
</style>
</head>
<body>

<div id="toolbar">
  <button id="penBtn" class="active">Pen</button>
  <button id="eraserBtn">Eraser</button>
  <button id="lineBtn">Line</button>
  <button id="rectBtn">Rect</button>
  <button id="circleBtn">Circle</button>
  <button id="textBtn">Text</button>
  <button id="selectBtn">Select</button>
  <div style="width:1px; height:25px; background:#555;"></div>
  <input type="color" id="colorPicker" value="#000000">
  <input type="range" id="sizePicker" min="1" max="50" value="3">
  <button id="extendBtn">+ Extend</button>
  <button id="exportBtn" style="background: #28a745;">Export PDF</button>
  <button id="clearBtn" style="background:#8b0000;">Clear</button>
</div>

<div id="canvas-container">
  <canvas id="canvas" width="1200" height="1500"></canvas>
  <input type="text" id="textInput">
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d", { willReadFrequently: true });
const colorPicker = document.getElementById("colorPicker");
const sizePicker = document.getElementById("sizePicker");
const textInput = document.getElementById("textInput");

let tool = "pen";
let drawing = false;
let isMovingSelection = false;
let isResizing = false;
let startX, startY, lastX, lastY;
let snapshot, selectionData, selectionRect = null;
let pasteImage = null; // For handling active transforms
const undoStack = [];

function saveState() {
  if (undoStack.length >= 30) undoStack.shift();
  undoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
}

function undo() {
  if (undoStack.length > 1) {
    undoStack.pop();
    ctx.putImageData(undoStack[undoStack.length - 1], 0, 0);
    selectionRect = null; 
  }
}

saveState();

function finalizeSelection() {
    if (selectionRect) {
        if (pasteImage) {
            ctx.drawImage(pasteImage, selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
            pasteImage = null;
        } else if (selectionData) {
            ctx.putImageData(selectionData, selectionRect.x, selectionRect.y);
        }
        selectionRect = null;
        selectionData = null;
        saveState();
        redrawUI();
    }
}

function finalizeText() {
    if (textInput.style.display === "block" && textInput.value.trim() !== "") {
        ctx.fillStyle = colorPicker.value;
        ctx.font = `${parseInt(sizePicker.value) + 15}px sans-serif`;
        ctx.textBaseline = "middle";
        ctx.fillText(textInput.value, startX, startY);
        saveState();
    }
    textInput.style.display = "none";
    textInput.value = "";
}

// Tool Selection
document.querySelectorAll("#toolbar button").forEach(btn => {
  btn.onclick = () => {
    if(btn.id === "clearBtn" && confirm("Clear Canvas?")) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        saveState(); return;
    }
    if(btn.id === "extendBtn") {
        const temp = ctx.getImageData(0, 0, canvas.width, canvas.height);
        canvas.height += 1000;
        ctx.putImageData(temp, 0, 0);
        saveState(); return;
    }
    if(btn.id === "exportBtn") { finalizeSelection(); window.print(); return; }

    finalizeSelection();
    finalizeText();

    tool = btn.id.replace("Btn", "");
    document.querySelectorAll("#toolbar button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  };
});

canvas.addEventListener("pointerdown", e => {
  const x = e.offsetX;
  const y = e.offsetY;

  // Handle Resize Handle (Bottom Right)
  if (selectionRect) {
      const handleSize = 15;
      if (x >= selectionRect.x + selectionRect.w - handleSize && x <= selectionRect.x + selectionRect.w + handleSize &&
          y >= selectionRect.y + selectionRect.h - handleSize && y <= selectionRect.y + selectionRect.h + handleSize) {
          isResizing = true;
          return;
      }
      // Handle Move
      if (x >= selectionRect.x && x <= selectionRect.x + selectionRect.w &&
          y >= selectionRect.y && y <= selectionRect.y + selectionRect.h) {
          isMovingSelection = true;
          lastX = x; lastY = y;
          return;
      }
      // Clicked outside selection
      finalizeSelection();
  }

  finalizeText();
  if (tool === "text") { showTextInput(e); return; }

  drawing = true;
  startX = x; startY = y;
  snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
  
  ctx.strokeStyle = colorPicker.value;
  ctx.lineWidth = sizePicker.value;
  ctx.lineCap = "round";
  ctx.lineJoin = "round";
  if (tool === 'pen' || tool === 'eraser') { ctx.beginPath(); ctx.moveTo(x, y); }
});

canvas.addEventListener("pointermove", e => {
  const x = e.offsetX;
  const y = e.offsetY;

  if (isResizing && selectionRect) {
      ctx.putImageData(snapshot, 0, 0);
      selectionRect.w = Math.max(20, x - selectionRect.x);
      selectionRect.h = Math.max(20, y - selectionRect.y);
      redrawUI();
      return;
  }

  if (isMovingSelection && selectionRect) {
    ctx.putImageData(snapshot, 0, 0);
    selectionRect.x += (x - lastX);
    selectionRect.y += (y - lastY);
    lastX = x; lastY = y;
    redrawUI();
    return;
  }

  if (!drawing) return;

  if (tool === "pen") {
    ctx.lineTo(x, y); ctx.stroke();
  } else if (tool === "eraser") {
    ctx.globalCompositeOperation = "destination-out";
    ctx.lineTo(x, y); ctx.stroke();
    ctx.globalCompositeOperation = "source-over";
  } else {
    ctx.putImageData(snapshot, 0, 0);
    if (tool === "line") {
      ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(x, y); ctx.stroke();
    } else if (tool === "rect") {
      ctx.strokeRect(startX, startY, x - startX, y - startY);
    } else if (tool === "circle") {
      ctx.beginPath(); ctx.arc(startX, startY, Math.hypot(x-startX, y-startY), 0, Math.PI*2); ctx.stroke();
    } else if (tool === "select") {
      drawSelectionDashes(startX, startY, x - startX, y - startY);
    }
  }
});

canvas.addEventListener("pointerup", e => {
  if (tool === "select" && drawing) {
    const w = e.offsetX - startX;
    const h = e.offsetY - startY;
    if (Math.abs(w) > 5 && Math.abs(h) > 5) {
      selectionRect = { x: startX, y: startY, w, h };
      selectionData = ctx.getImageData(startX, startY, w, h);
      ctx.clearRect(startX, startY, w, h);
      snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
      redrawUI();
    }
  }
  drawing = false; isMovingSelection = false; isResizing = false;
  if (tool !== "select" && !selectionRect) saveState();
});

function redrawUI() {
    if (!selectionRect) return;
    if (pasteImage) {
        ctx.drawImage(pasteImage, selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
    } else if (selectionData) {
        // Draw selection data scaled if resized
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = selectionData.width;
        tempCanvas.height = selectionData.height;
        tempCanvas.getContext('2d').putImageData(selectionData, 0, 0);
        ctx.drawImage(tempCanvas, selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
    }
    drawSelectionDashes(selectionRect.x, selectionRect.y, selectionRect.w, selectionRect.h);
}

function drawSelectionDashes(x, y, w, h) {
  ctx.setLineDash([5, 5]);
  ctx.strokeStyle = "#007bff";
  ctx.lineWidth = 1;
  ctx.strokeRect(x, y, w, h);
  // Draw resize handle
  ctx.fillStyle = "#007bff";
  ctx.fillRect(x + w - 5, y + h - 5, 10, 10);
  ctx.setLineDash([]);
}

/* =========================
   PASTE & TEXT
========================= */
window.addEventListener('paste', e => {
  const items = e.clipboardData.items;
  for (let item of items) {
    if (item.type.indexOf("image") !== -1) {
      const blob = item.getAsFile();
      const img = new Image();
      img.onload = () => {
        finalizeSelection();
        snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
        pasteImage = img;
        selectionRect = { x: 50, y: 50, w: img.width, h: img.height };
        redrawUI();
      };
      img.src = URL.createObjectURL(blob);
    }
  }
});

function showTextInput(e) {
  const fontSize = parseInt(sizePicker.value) + 15;
  textInput.style.display = "block";
  textInput.style.left = e.pageX + "px";
  textInput.style.top = (e.pageY - fontSize/2) + "px";
  textInput.style.fontSize = fontSize + "px";
  textInput.style.color = colorPicker.value;
  startX = e.offsetX; startY = e.offsetY;
  setTimeout(() => textInput.focus(), 10);
}

textInput.onblur = () => finalizeText();
textInput.onkeydown = e => { if (e.key === "Enter") finalizeText(); };

document.addEventListener("keydown", e => {
  if (e.key === "Delete" && selectionRect) {
    ctx.putImageData(snapshot, 0, 0);
    selectionRect = null; pasteImage = null; saveState();
  }
  if (e.ctrlKey && e.key === "z") { e.preventDefault(); undo(); }
});
</script>
</body>
</html>
