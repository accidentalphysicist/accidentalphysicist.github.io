<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Web Notebook â€“ Fixed Prototype</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<style>
body {
  margin: 0;
  background: #121212;
  color: #eee;
  font-family: system-ui, sans-serif;
}

.toolbar {
  display: flex;
  gap: 8px;
  padding: 10px;
  background: #1e1e1e;
  border-bottom: 1px solid #333;
  flex-wrap: wrap;
}

button {
  background: #2a2a2a;
  color: white;
  border: 2px solid transparent;
  padding: 6px 10px;
  cursor: pointer;
}

button.active {
  border: 2px solid #4cafef;
}

.color {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  cursor: pointer;
  border: 3px solid transparent;
}

.color.active {
  border-color: #fff;
}

canvas {
  background: #181818;
  display: block;
}
</style>
</head>

<body>

<div class="toolbar">
  <button data-tool="pen">Pen</button>
  <button data-tool="eraser">Eraser</button>
  <button data-tool="rect">Rect</button>
  <button data-tool="circle">Circle</button>
  <button data-tool="triangle">Triangle</button>
  <button data-tool="line">Line</button>

  <label>Size</label>
  <input type="range" id="size" min="1" max="40" value="5">

  <label>Fill</label>
  <input type="checkbox" id="fill">

  <div class="color" data-color="white" style="background:white"></div>
  <div class="color" data-color="red" style="background:red"></div>
  <div class="color" data-color="green" style="background:green"></div>
  <div class="color" data-color="blue" style="background:blue"></div>
</div>

<canvas id="c" width="1400" height="700"></canvas>

<script>
const canvas = new fabric.Canvas('c');
let currentTool = null;
let currentColor = 'white';
let currentSize = 5;
let drawingObject = null;
let startX, startY;

// ---------- TOOL STATE ----------
const toolButtons = document.querySelectorAll('button[data-tool]');
toolButtons.forEach(btn => {
  btn.onclick = () => setTool(btn.dataset.tool, btn);
});

function setTool(tool, btn) {
  toolButtons.forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  currentTool = tool;
  canvas.isDrawingMode = false;

  if (tool === 'pen') {
    canvas.isDrawingMode = true;
    canvas.freeDrawingBrush.color = currentColor;
    canvas.freeDrawingBrush.width = currentSize;
  }
}

// ---------- COLORS ----------
const colors = document.querySelectorAll('.color');
colors.forEach(c => {
  c.onclick = () => {
    colors.forEach(x => x.classList.remove('active'));
    c.classList.add('active');
    currentColor = c.dataset.color;
    if (canvas.freeDrawingBrush) {
      canvas.freeDrawingBrush.color = currentColor;
    }
  };
});
colors[0].click();

// ---------- SIZE ----------
document.getElementById('size').oninput = e => {
  currentSize = parseInt(e.target.value);
  if (canvas.freeDrawingBrush) {
    canvas.freeDrawingBrush.width = currentSize;
  }
};

// ---------- DRAW SHAPES ----------
canvas.on('mouse:down', e => {
  if (!['rect','circle','triangle','line'].includes(currentTool)) return;

  const p = canvas.getPointer(e.e);
  startX = p.x;
  startY = p.y;

  const common = {
    left: startX,
    top: startY,
    stroke: currentColor,
    strokeWidth: 2,
    fill: document.getElementById('fill').checked ? currentColor : null,
    selectable: false
  };

  if (currentTool === 'rect')
    drawingObject = new fabric.Rect({ ...common, width: 1, height: 1 });

  if (currentTool === 'circle')
    drawingObject = new fabric.Circle({ ...common, radius: 1 });

  if (currentTool === 'triangle')
    drawingObject = new fabric.Triangle({ ...common, width: 1, height: 1 });

  if (currentTool === 'line')
    drawingObject = new fabric.Line([startX, startY, startX, startY], {
      stroke: currentColor, strokeWidth: 2, selectable: false
    });

  canvas.add(drawingObject);
});

canvas.on('mouse:move', e => {
  if (!drawingObject) return;
  const p = canvas.getPointer(e.e);

  if (drawingObject.type === 'rect' || drawingObject.type === 'triangle') {
    drawingObject.set({
      width: Math.abs(p.x - startX),
      height: Math.abs(p.y - startY)
    });
  }

  if (drawingObject.type === 'circle') {
    drawingObject.set({
      radius: Math.hypot(p.x - startX, p.y - startY) / 2
    });
  }

  if (drawingObject.type === 'line') {
    drawingObject.set({ x2: p.x, y2: p.y });
  }

  canvas.requestRenderAll();
});

canvas.on('mouse:up', () => {
  if (drawingObject) {
    drawingObject.set({ selectable: true });
    drawingObject = null;
  }
});

// ---------- ERASER ----------
canvas.on('mouse:move', e => {
  if (currentTool !== 'eraser') return;
  const target = canvas.findTarget(e.e, false);
  if (target) canvas.remove(target);
});
</script>

</body>
</html>
