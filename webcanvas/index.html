<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Teaching Canvas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background: #f8f8f8; font-family: sans-serif; }
        #canvas-container {
            width: 100vw; height: 100vh; overflow-y: auto; overflow-x: hidden;
            background-image: radial-gradient(#ccc 1px, transparent 1px);
            background-size: 30px 30px; position: relative;
        }
        #tool-panel {
            position: fixed; left: 0; top: 50%; transform: translateY(-50%);
            width: 40px; background: white; border: 1px solid #ddd;
            border-radius: 0 10px 10px 0; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: width 0.3s; z-index: 1000; padding: 10px 5px;
            display: flex; flex-direction: column; align-items: center;
        }
        #tool-panel:hover { width: 90px; }
        .tool { font-size: 18px; margin: 5px 0; cursor: pointer; color: #666; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .tool.active { color: white; background: #4A90E2; }
        
        /* Shape Tray Styles */
        #shape-tray {
            position: fixed; left: -250px; top: 50%; transform: translateY(-50%);
            width: 200px; background: white; border: 1px solid #ddd; border-radius: 10px;
            padding: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;
            transition: left 0.3s; z-index: 999; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        #shape-tray.visible { left: 50px; }
        .shape-opt { font-size: 14px; padding: 8px; cursor: pointer; text-align: center; border-radius: 5px; border: 1px solid #eee; }
        .shape-opt:hover { background: #f0f0f0; }

        input, select { width: 50px; margin: 4px 0; font-size: 10px; }
        .fill-toggle { font-size: 10px; margin-top: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div id="tool-panel">
    <div class="tool active" id="pen-btn"><i class="fas fa-pen"></i></div>
    <div class="tool" id="pencil-btn"><i class="fas fa-pencil-alt"></i></div>
    <div class="tool" id="marker-btn"><i class="fas fa-highlighter"></i></div>
    <div class="tool" id="eraser-btn"><i class="fas fa-eraser"></i></div>
    <div class="tool" id="text-btn"><i class="fas fa-font"></i></div>
    <hr style="width:80%">
    <input type="color" id="colorPicker" value="#000000">
    <input type="number" id="sizePicker" value="5" min="1">
    <select id="fontPicker"><option value="Arial">Arial</option><option value="Courier">Mono</option></select>
    <hr style="width:80%">
    <div class="tool" id="shapes-toggle" style="color:#8e44ad"><i class="fas fa-shapes"></i></div>
    <div class="fill-toggle"><input type="checkbox" id="fillShapes"> Fill</div>
    <hr style="width:80%">
    <div class="tool" id="pdf-btn" style="color:#27ae60"><i class="fas fa-file-pdf"></i></div>
    <div class="tool" id="clear-btn" style="color:#e74c3c"><i class="fas fa-trash-alt"></i></div>
</div>

<div id="shape-tray">
    <div class="shape-opt" onclick="addShape('rect')">Rect</div>
    <div class="shape-opt" onclick="addShape('roundRect')">R-Rect</div>
    <div class="shape-opt" onclick="addShape('circle')">Circle</div>
    <div class="shape-opt" onclick="addShape('square')">Square</div>
    <div class="shape-opt" onclick="addShape('line')">Line</div>
    <div class="shape-opt" onclick="addShape('arrow')">Arrow</div>
    <div class="shape-opt" onclick="addShape('axes')">Axes</div>
    <div class="shape-opt" onclick="addShape('star')">Star</div>
    <div class="shape-opt" onclick="addShape('semi')">Semi</div>
</div>

<div id="canvas-container"><canvas id="c"></canvas></div>

<script>
    const { jsPDF } = window.jspdf;
    const container = document.getElementById('canvas-container');
    const canvas = new fabric.Canvas('c', { width: window.innerWidth, height: 4000, isDrawingMode: true, backgroundColor: null });

    let mode = 'pen';
    const colorInp = document.getElementById('colorPicker');
    const sizeInp = document.getElementById('sizePicker');
    const fillInp = document.getElementById('fillShapes');

    function applyBrush() {
        canvas.isDrawingMode = ['pen', 'pencil', 'marker', 'eraser'].includes(mode);
        if (!canvas.isDrawingMode) return;
        canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
        const color = colorInp.value, size = parseInt(sizeInp.value);
        if (mode === 'pen') { canvas.freeDrawingBrush.color = color; canvas.freeDrawingBrush.width = size; }
        else if (mode === 'pencil') { canvas.freeDrawingBrush.color = color + '80'; canvas.freeDrawingBrush.width = size * 0.7; }
        else if (mode === 'marker') { canvas.freeDrawingBrush.color = color + '4D'; canvas.freeDrawingBrush.width = size * 5; canvas.freeDrawingBrush.strokeLineCap = 'square'; }
        else if (mode === 'eraser') { canvas.freeDrawingBrush.color = '#f8f8f8'; canvas.freeDrawingBrush.width = size * 10; }
    }

    // TOGGLE SHAPE TRAY
    document.getElementById('shapes-toggle').onclick = () => document.getElementById('shape-tray').classList.toggle('visible');

    function addShape(type) {
        mode = 'select';
        canvas.isDrawingMode = false;
        const color = colorInp.value;
        const fill = fillInp.checked ? color + '4D' : 'transparent';
        const common = { left: 200, top: container.scrollTop + 200, fill: fill, stroke: color, strokeWidth: 2 };
        
        let obj;
        if (type === 'rect') obj = new fabric.Rect({...common, width: 150, height: 80});
        else if (type === 'roundRect') obj = new fabric.Rect({...common, width: 150, height: 80, rx: 15, ry: 15});
        else if (type === 'circle') obj = new fabric.Circle({...common, radius: 50});
        else if (type === 'square') obj = new fabric.Rect({...common, width: 100, height: 100});
        else if (type === 'line') obj = new fabric.Line([50, 50, 200, 50], {stroke: color, strokeWidth: 2, left: 200, top: container.scrollTop + 200});
        else if (type === 'arrow') {
            obj = new fabric.Path('M 0 0 L 100 0 M 100 0 L 80 -10 M 100 0 L 80 10', {...common, fill: 'transparent'});
        }
        else if (type === 'axes') {
            obj = new fabric.Path('M 0 100 L 0 0 M 0 100 L 100 100', {...common, fill: 'transparent'});
        }
        
        canvas.add(obj);
        canvas.setActiveObject(obj);
        document.getElementById('shape-tray').classList.remove('visible');
    }

    // EXPORT PDF WITH BACKGROUND
    document.getElementById('pdf-btn').onclick = () => {
        // 1. Temporarily set a background color and grid for export
        canvas.setBackgroundColor('#f8f8f8', () => {
            const dataURL = canvas.toDataURL({ format: 'png', quality: 1 });
            const pdf = new jsPDF('p', 'px', [canvas.width, canvas.height]);
            pdf.addImage(dataURL, 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save("canvas-export.pdf");
            
            // 2. Remove background immediately after export
            canvas.setBackgroundColor(null, canvas.renderAll.bind(canvas));
        });
    };

    // Standard Listeners
    document.getElementById('pen-btn').onclick = () => { mode = 'pen'; applyBrush(); };
    document.getElementById('eraser-btn').onclick = () => { mode = 'eraser'; applyBrush(); };
    document.getElementById('text-btn').onclick = () => { 
        mode = 'text'; canvas.isDrawingMode = false;
        canvas.add(new fabric.Textbox('Text', {left: 200, top: container.scrollTop + 200, fill: colorInp.value}));
    };
    
    colorInp.oninput = applyBrush;
    sizeInp.oninput = applyBrush;
    container.onscroll = () => { if(container.scrollTop + container.clientHeight > canvas.getHeight() - 800) canvas.setHeight(canvas.getHeight() + 2000); };
    window.onkeydown = (e) => { if((e.key === "Delete" || e.key === "Backspace") && canvas.getActiveObject() && !canvas.getActiveObject().isEditing) canvas.remove(...canvas.getActiveObjects()); };
    applyBrush();
</script>
</body>
</html>
