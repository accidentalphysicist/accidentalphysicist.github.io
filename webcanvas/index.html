<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Teaching Canvas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        /* 1. LAYOUT & GRID STYLES */
        body, html { margin: 0; padding: 0; overflow: hidden; background: #f8f8f8; }
        
        #canvas-container {
            width: 100vw;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            /* Dotted Grid Pattern */
            background-image: radial-gradient(#ccc 1px, transparent 1px);
            background-size: 30px 30px;
            position: relative;
        }

        canvas { display: block; }

        /* 2. PANEL STYLES */
        #tool-panel {
            position: fixed; left: 0; top: 50%;
            transform: translateY(-50%);
            width: 35px; background: white;
            border: 1px solid #ddd; border-radius: 0 10px 10px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: width 0.3s ease; z-index: 1000;
            padding: 10px 5px; display: flex;
            flex-direction: column; align-items: center;
            overflow: hidden;
        }
        #tool-panel:hover { width: 80px; }

        .tool {
            font-size: 20px; margin: 8px 0; cursor: pointer;
            color: #888; width: 45px; height: 45px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px; transition: 0.2s;
        }
        .tool.active { color: white; background: #4A90E2; }
        .panel-divider { width: 80%; border: 0; border-top: 1px solid #eee; margin: 10px 0; }
        
        input, select { width: 50px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="tool-panel">
        <div class="tool active" id="pen-btn" title="Pen"><i class="fas fa-pen"></i></div>
        <div class="tool" id="pencil-btn" title="Pencil"><i class="fas fa-pencil-alt"></i></div>
        <div class="tool" id="marker-btn" title="Marker"><i class="fas fa-highlighter"></i></div>
        <div class="tool" id="eraser-btn" title="Eraser"><i class="fas fa-eraser"></i></div>
        <div class="tool" id="text-btn" title="Text Box"><i class="fas fa-font"></i></div>
        
        <hr class="panel-divider">
        <input type="color" id="colorPicker" value="#000000">
        <input type="number" id="sizePicker" value="5" min="1">
        <select id="fontPicker">
            <option value="Arial">Arial</option>
            <option value="Courier New">Mono</option>
            <option value="Times New Roman">Serif</option>
        </select>

        <hr class="panel-divider">
        <div class="tool" id="clear-btn" style="color:#e74c3c"><i class="fas fa-trash-alt"></i></div>
    </div>

    <div id="canvas-container">
        <canvas id="c"></canvas>
    </div>

    <script>
        // 1. CANVAS INITIALIZATION
        const container = document.getElementById('canvas-container');
        const canvas = new fabric.Canvas('c', {
            width: window.innerWidth,
            height: 4000, 
            isDrawingMode: true,
            backgroundColor: null // Keeps it transparent to show CSS dots
        });

        // 2. INFINITE SCROLL LOGIC
        container.addEventListener('scroll', () => {
            const scrollBottom = container.scrollTop + container.clientHeight;
            if (scrollBottom > canvas.getHeight() - 800) {
                canvas.setHeight(canvas.getHeight() + 2000);
                canvas.renderAll();
            }
        });

        // 3. TOOL & BRUSH LOGIC
        let currentMode = 'pen';
        const colorInp = document.getElementById('colorPicker');
        const sizeInp = document.getElementById('sizePicker');
        const fontInp = document.getElementById('fontPicker');

        function hexToRgba(hex, opacity) {
            const r = parseInt(hex.slice(1, 3), 16),
                  g = parseInt(hex.slice(3, 5), 16),
                  b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r},${g},${b},${opacity})`;
        }

        function applyBrushSettings() {
            canvas.isDrawingMode = (currentMode !== 'text');
            if (!canvas.isDrawingMode) return;

            canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
            const color = colorInp.value;
            const size = parseInt(sizeInp.value);

            if (currentMode === 'pen') {
                canvas.freeDrawingBrush.color = color;
                canvas.freeDrawingBrush.width = size;
            } else if (currentMode === 'pencil') {
                canvas.freeDrawingBrush.color = hexToRgba(color, 0.4);
                canvas.freeDrawingBrush.width = size * 0.7;
            } else if (currentMode === 'marker') {
                canvas.freeDrawingBrush.color = hexToRgba(color, 0.3);
                canvas.freeDrawingBrush.width = size * 5;
                canvas.freeDrawingBrush.strokeLineCap = 'square';
            } else if (currentMode === 'eraser') {
                // Reliable White Paint Eraser
                canvas.freeDrawingBrush.color = '#f8f8f8';
                canvas.freeDrawingBrush.width = size * 10;
            }
        }

        // 4. UI HANDLERS
        const btns = { 'pen-btn':'pen', 'pencil-btn':'pencil', 'marker-btn':'marker', 'eraser-btn':'eraser', 'text-btn':'text' };
        
        Object.keys(btns).forEach(id => {
            document.getElementById(id).onclick = () => {
                currentMode = btns[id];
                document.querySelectorAll('.tool').forEach(t => t.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                
                if (currentMode === 'text') {
                    canvas.isDrawingMode = false;
                    addText();
                } else {
                    applyBrushSettings();
                }
            };
        });

        function addText() {
            const text = new fabric.Textbox('Edit Me', {
                left: 150,
                top: container.scrollTop + 150,
                width: 250,
                fontSize: 40,
                fill: colorInp.value,
                fontFamily: fontInp.value
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        // 5. DYNAMIC UPDATES & KEYBOARD
        colorInp.oninput = applyBrushSettings;
        sizeInp.oninput = applyBrushSettings;

        window.addEventListener('keydown', (e) => {
            if ((e.key === "Delete" || e.key === "Backspace")) {
                const activeObjects = canvas.getActiveObjects();
                const isTyping = activeObjects.some(obj => obj.isEditing);
                if (activeObjects.length > 0 && !isTyping) {
                    canvas.remove(...activeObjects);
                    canvas.discardActiveObject().renderAll();
                }
            }
        });

        document.getElementById('clear-btn').onclick = () => {
            if(confirm("Clear board?")) { canvas.clear(); applyBrushSettings(); }
        };

        window.addEventListener('resize', () => canvas.setWidth(window.innerWidth));

        applyBrushSettings(); // Load default
    </script>
</body>
</html>
