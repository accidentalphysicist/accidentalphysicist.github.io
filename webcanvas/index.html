<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adv Teaching Canvas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background: #f8f8f8; font-family: sans-serif; }
        #canvas-container {
            width: 100vw; height: 100vh; overflow-y: auto; overflow-x: hidden;
            background-image: radial-gradient(#ccc 1px, transparent 1px);
            background-size: 30px 30px; position: relative;
        }
        #tool-panel {
            position: fixed; left: 0; top: 50%; transform: translateY(-50%);
            width: 40px; background: white; border: 1px solid #ddd;
            border-radius: 0 10px 10px 0; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: width 0.3s; z-index: 1000; padding: 10px 5px;
            display: flex; flex-direction: column; align-items: center;
        }
        #tool-panel:hover { width: 90px; }
        .tool { font-size: 18px; margin: 5px 0; cursor: pointer; color: #666; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: 0.2s; }
        .tool.active { color: white; background: #4A90E2; }
        
        #shape-tray {
            position: fixed; left: -250px; top: 50%; transform: translateY(-50%);
            width: 200px; background: white; border: 1px solid #ddd; border-radius: 10px;
            padding: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;
            transition: left 0.3s; z-index: 999; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        #shape-tray.visible { left: 50px; }
        .shape-opt { font-size: 12px; padding: 8px; cursor: pointer; text-align: center; border-radius: 5px; border: 1px solid #eee; background: #fafafa; }
        .shape-opt:hover { background: #f0f0f0; border-color: #4A90E2; }

        input, select { width: 50px; margin: 4px 0; font-size: 10px; }
        .fill-label { font-size: 10px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>

<div id="tool-panel">
    <div class="tool active" id="pen-btn" onclick="setMode('pen')"><i class="fas fa-pen"></i></div>
    <div class="tool" id="pencil-btn" onclick="setMode('pencil')"><i class="fas fa-pencil-alt"></i></div>
    <div class="tool" id="marker-btn" onclick="setMode('marker')"><i class="fas fa-highlighter"></i></div>
    <div class="tool" id="eraser-btn" onclick="setMode('eraser')"><i class="fas fa-eraser"></i></div>
    <div class="tool" id="text-btn" onclick="setMode('text')"><i class="fas fa-font"></i></div>
    <hr style="width:80%">
    <input type="color" id="colorPicker" value="#000000">
    <input type="number" id="sizePicker" value="5" min="1">
    <select id="fontPicker"><option value="Arial">Arial</option><option value="Courier">Mono</option></select>
    <hr style="width:80%">
    <div class="tool" id="shapes-toggle" onclick="toggleTray()" style="color:#8e44ad"><i class="fas fa-shapes"></i></div>
    <div class="fill-label"><input type="checkbox" id="fillShapes"> Fill</div>
    <hr style="width:80%">
    <div class="tool" id="pdf-btn" onclick="exportPDF()" style="color:#27ae60"><i class="fas fa-file-pdf"></i></div>
    <div class="tool" id="clear-btn" onclick="clearBoard()" style="color:#e74c3c"><i class="fas fa-trash-alt"></i></div>
</div>

<div id="shape-tray">
    <div class="shape-opt" onclick="addShape('rect')">Rect</div>
    <div class="shape-opt" onclick="addShape('circle')">Circle</div>
    <div class="shape-opt" onclick="addShape('square')">Square</div>
    <div class="shape-opt" onclick="addShape('line')">Line</div>
    <div class="shape-opt" onclick="addShape('arrow')">Arrow</div>
    <div class="shape-opt" onclick="addShape('axes')">Axes</div>
    <div class="shape-opt" onclick="addShape('star')">Star</div>
    <div class="shape-opt" onclick="addShape('semi')">Semi</div>
    <div class="shape-opt" onclick="addShape('arc')">Arc</div>
</div>

<div id="canvas-container"><canvas id="c"></canvas></div>

<script>
    const { jsPDF } = window.jspdf;
    const container = document.getElementById('canvas-container');
    const canvas = new fabric.Canvas('c', { 
        width: window.innerWidth, 
        height: 4000, 
        isDrawingMode: true, 
        backgroundColor: null 
    });

    let currentMode = 'pen';
    const colorInp = document.getElementById('colorPicker');
    const sizeInp = document.getElementById('sizePicker');
    const fillInp = document.getElementById('fillShapes');

    // Utility for colors
    function hexToRgba(hex, opacity) {
        const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r},${g},${b},${opacity})`;
    }

    // 1. TOOL SWITCHING LOGIC
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.tool').forEach(t => t.classList.remove('active'));
        document.getElementById(`${mode}-btn`).classList.add('active');
        
        if (mode === 'text') {
            canvas.isDrawingMode = false;
            addText();
        } else {
            canvas.isDrawingMode = true;
            applyBrush();
        }
    }

    function applyBrush() {
        if (!canvas.isDrawingMode) return;
        canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
        const color = colorInp.value, size = parseInt(sizeInp.value);

        if (currentMode === 'pen') { canvas.freeDrawingBrush.color = color; canvas.freeDrawingBrush.width = size; }
        else if (currentMode === 'pencil') { canvas.freeDrawingBrush.color = hexToRgba(color, 0.4); canvas.freeDrawingBrush.width = size * 0.7; }
        else if (currentMode === 'marker') { canvas.freeDrawingBrush.color = hexToRgba(color, 0.3); canvas.freeDrawingBrush.width = size * 5; canvas.freeDrawingBrush.strokeLineCap = 'square'; }
        else if (currentMode === 'eraser') { canvas.freeDrawingBrush.color = '#f8f8f8'; canvas.freeDrawingBrush.width = size * 10; }
    }

    // 2. SHAPE LOGIC
    function toggleTray() { document.getElementById('shape-tray').classList.toggle('visible'); }

    function addShape(type) {
        canvas.isDrawingMode = false;
        const color = colorInp.value;
        const fill = fillInp.checked ? hexToRgba(color, 0.3) : 'transparent';
        const common = { left: 200, top: container.scrollTop + 200, fill: fill, stroke: color, strokeWidth: 2 };
        
        let obj;
        if (type === 'rect') obj = new fabric.Rect({...common, width: 150, height: 80});
        else if (type === 'circle') obj = new fabric.Circle({...common, radius: 50});
        else if (type === 'square') obj = new fabric.Rect({...common, width: 100, height: 100});
        else if (type === 'line') obj = new fabric.Line([50, 50, 200, 50], {stroke: color, strokeWidth: 2, left: 200, top: container.scrollTop + 200});
        else if (type === 'arrow') {
            obj = new fabric.Path('M 0 0 L 100 0 M 100 0 L 85 -8 M 100 0 L 85 8', {...common, fill: 'transparent'});
        }
        else if (type === 'axes') {
            // Axes with arrows
            obj = new fabric.Path('M 0 100 L 0 0 M 0 0 L -5 10 M 0 0 L 5 10 M 0 100 L 100 100 M 100 100 L 90 95 M 100 100 L 90 105', {...common, fill: 'transparent'});
        }
        else if (type === 'star') {
            obj = new fabric.Path('M 50 0 L 61 35 L 98 35 L 68 57 L 79 91 L 50 70 L 21 91 L 32 57 L 2 35 L 39 35 Z', common);
        }
        else if (type === 'semi') {
            obj = new fabric.Path('M 100 100 A 50 50 0 0 0 0 100 Z', common);
        }
        else if (type === 'arc') {
            obj = new fabric.Path('M 100 100 A 50 50 0 0 0 0 100', {...common, fill: 'transparent'});
        }

        canvas.add(obj);
        canvas.setActiveObject(obj);
        document.getElementById('shape-tray').classList.remove('visible');
    }

    function addText() {
        const text = new fabric.Textbox('Edit', { left: 200, top: container.scrollTop + 200, fill: colorInp.value, fontSize: 30, fontFamily: document.getElementById('fontPicker').value });
        canvas.add(text);
        canvas.setActiveObject(text);
    }

    // 3. EXPORT & SYSTEM
    function exportPDF() {
        canvas.setBackgroundColor('#f8f8f8', () => {
            const dataURL = canvas.toDataURL({ format: 'png', quality: 1 });
            const pdf = new jsPDF('p', 'px', [canvas.width, canvas.height]);
            pdf.addImage(dataURL, 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save("whiteboard-export.pdf");
            canvas.setBackgroundColor(null, canvas.renderAll.bind(canvas));
        });
    }

    function clearBoard() { if(confirm("Clear board?")) canvas.clear(); applyBrush(); }

    // Listeners
    colorInp.oninput = applyBrush;
    sizeInp.oninput = applyBrush;
    container.onscroll = () => { if(container.scrollTop + container.clientHeight > canvas.getHeight() - 800) canvas.setHeight(canvas.getHeight() + 2000); };
    window.onkeydown = (e) => { if((e.key === "Delete" || e.key === "Backspace") && canvas.getActiveObject() && !canvas.getActiveObject().isEditing) canvas.remove(...canvas.getActiveObjects()); };
    
    applyBrush();
</script>
</body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Advanced Teaching Whiteboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background: #f8f8f8; font-family: sans-serif; }
        #canvas-container {
            width: 100vw; height: 100vh; overflow-y: auto; overflow-x: hidden;
            background-image: radial-gradient(#ccc 1px, transparent 1px);
            background-size: 30px 30px; position: relative;
        }
        #tool-panel {
            position: fixed; left: 0; top: 50%; transform: translateY(-50%);
            width: 45px; background: white; border: 1px solid #ddd;
            border-radius: 0 10px 10px 0; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: width 0.3s; z-index: 1000; padding: 10px 5px;
            display: flex; flex-direction: column; align-items: center;
        }
        #tool-panel:hover { width: 110px; }
        .tool { font-size: 18px; margin: 4px 0; cursor: pointer; color: #666; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .tool.active { color: white; background: #4A90E2; }
        #shape-tray {
            position: fixed; left: -250px; top: 50%; transform: translateY(-50%);
            width: 200px; background: white; border: 1px solid #ddd; border-radius: 10px;
            padding: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;
            transition: left 0.3s; z-index: 999;
        }
        #shape-tray.visible { left: 55px; }
        .shape-opt { font-size: 11px; padding: 5px; cursor: pointer; text-align: center; border: 1px solid #eee; background: #fafafa; }
        .text-styles { display: flex; flex-wrap: wrap; justify-content: center; gap: 2px; margin-top: 5px; }
        .style-btn { font-size: 12px; cursor: pointer; padding: 2px 5px; border: 1px solid #ddd; border-radius: 3px; background: #eee; }
        input, select { width: 70px; margin: 4px 0; font-size: 11px; }
    </style>
</head>
<body>

<div id="tool-panel">
    <div class="tool" id="select-btn" onclick="setMode('select')"><i class="fas fa-mouse-pointer"></i></div>
    <div class="tool active" id="pen-btn" onclick="setMode('pen')"><i class="fas fa-pen"></i></div>
    <div class="tool" id="pencil-btn" onclick="setMode('pencil')"><i class="fas fa-pencil-alt"></i></div>
    <div class="tool" id="marker-btn" onclick="setMode('marker')"><i class="fas fa-highlighter"></i></div>
    <div class="tool" id="eraser-btn" onclick="setMode('eraser')"><i class="fas fa-eraser"></i></div>
    <div class="tool" id="text-btn" onclick="setMode('text')"><i class="fas fa-font"></i></div>
    
    <div class="text-styles">
        <div class="style-btn" onclick="formatText('bold')" title="Ctrl+B">B</div>
        <div class="style-btn" onclick="formatText('italic')" title="Ctrl+I">I</div>
        <div class="style-btn" onclick="formatText('sup')" title="Ctrl+.">x²</div>
        <div class="style-btn" onclick="formatText('sub')" title="Ctrl+,">x₂</div>
    </div>

    <hr style="width:80%">
    <input type="color" id="colorPicker" value="#000000">
    <input type="number" id="sizePicker" value="5" min="1">
    <select id="fontPicker">
        <option value="Arial">Arial</option>
        <option value="Courier New">Monospace</option>
        <option value="Times New Roman">Serif</option>
        <option value="Verdana">Verdana</option>
        <option value="Comic Sans MS">Comic</option>
    </select>
    
    <hr style="width:80%">
    <div class="tool" id="shapes-toggle" onclick="toggleTray()" style="color:#8e44ad"><i class="fas fa-shapes"></i></div>
    <div style="font-size: 9px;"><input type="checkbox" id="fillShapes"> Fill</div>
    <hr style="width:80%">
    <div class="tool" id="pdf-btn" onclick="exportPDF()" style="color:#27ae60"><i class="fas fa-file-pdf"></i></div>
    <div class="tool" id="clear-btn" onclick="clearBoard()" style="color:#e74c3c"><i class="fas fa-trash-alt"></i></div>
</div>

<div id="shape-tray">
    <div class="shape-opt" onclick="addShape('rect')">Rect</div>
    <div class="shape-opt" onclick="addShape('circle')">Circle</div>
    <div class="shape-opt" onclick="addShape('line')">Line</div>
    <div class="shape-opt" onclick="addShape('arrow')">Arrow</div>
    <div class="shape-opt" onclick="addShape('axes')">Axes</div>
</div>

<div id="canvas-container"><canvas id="c"></canvas></div>

<script>
    const { jsPDF } = window.jspdf;
    const container = document.getElementById('canvas-container');
    const canvas = new fabric.Canvas('c', { width: window.innerWidth, height: 4000, isDrawingMode: true, backgroundColor: null });

    let currentMode = 'pen';
    const colorInp = document.getElementById('colorPicker');
    const sizeInp = document.getElementById('sizePicker');

    // --- UNDO / REDO SYSTEM ---
    let history = [];
    let redoStack = [];
    let isResetting = false;

    function saveHistory() {
        if (isResetting) return;
        history.push(JSON.stringify(canvas));
        redoStack = []; // Clear redo when new action happens
    }

    canvas.on('object:added', saveHistory);
    canvas.on('object:modified', saveHistory);
    canvas.on('path:created', saveHistory);

    function undo() {
        if (history.length <= 1) return;
        isResetting = true;
        redoStack.push(history.pop());
        const lastState = history[history.length - 1];
        canvas.loadFromJSON(lastState, () => {
            canvas.renderAll();
            isResetting = false;
        });
    }

    function redo() {
        if (redoStack.length === 0) return;
        isResetting = true;
        const state = redoStack.pop();
        history.push(state);
        canvas.loadFromJSON(state, () => {
            canvas.renderAll();
            isResetting = false;
        });
    }

    // --- KEYBOARD SHORTCUTS ---
    window.addEventListener('keydown', (e) => {
        const obj = canvas.getActiveObject();
        const isEditing = obj && obj.isEditing;

        if (e.ctrlKey || e.metaKey) {
            if (e.key === 'z') { e.preventDefault(); undo(); }
            if (e.key === 'r' || e.key === 'y') { e.preventDefault(); redo(); }
            
            if (isEditing) {
                if (e.key === 'b') { e.preventDefault(); formatText('bold'); }
                if (e.key === 'i') { e.preventDefault(); formatText('italic'); }
                if (e.key === 'u') { e.preventDefault(); formatText('underline'); }
                if (e.key === '.') { e.preventDefault(); formatText('sup'); }
                if (e.key === ',') { e.preventDefault(); formatText('sub'); }
            }
        }
        
        if ((e.key === "Delete" || e.key === "Backspace") && obj && !isEditing) {
            canvas.remove(...canvas.getActiveObjects());
            canvas.discardActiveObject().renderAll();
        }
    });

    // --- CORE TOOLS ---
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.tool').forEach(t => t.classList.remove('active'));
        if(document.getElementById(`${mode}-btn`)) document.getElementById(`${mode}-btn`).classList.add('active');
        canvas.isDrawingMode = (['pen', 'pencil', 'marker', 'eraser'].includes(mode));
        if (mode === 'text') addText();
        if (canvas.isDrawingMode) applyBrush();
    }

    function applyBrush() {
        canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
        const color = colorInp.value, size = parseInt(sizeInp.value);
        if (currentMode === 'pen') { canvas.freeDrawingBrush.color = color; canvas.freeDrawingBrush.width = size; }
        else if (currentMode === 'pencil') { canvas.freeDrawingBrush.color = color + '80'; canvas.freeDrawingBrush.width = size * 0.7; }
        else if (currentMode === 'marker') { canvas.freeDrawingBrush.color = color + '4D'; canvas.freeDrawingBrush.width = size * 6; canvas.freeDrawingBrush.strokeLineCap = 'square'; }
        else if (currentMode === 'eraser') { canvas.freeDrawingBrush.color = '#f8f8f8'; canvas.freeDrawingBrush.width = size * 10; }
    }

    function formatText(style) {
        const obj = canvas.getActiveObject();
        if (!obj || obj.type !== 'textbox') return;
        
        if (style === 'bold') obj.set('fontWeight', obj.fontWeight === 'bold' ? 'normal' : 'bold');
        else if (style === 'italic') obj.set('fontStyle', obj.fontStyle === 'italic' ? 'normal' : 'italic');
        else if (style === 'underline') obj.set('underline', !obj.underline);
        else if (style === 'sup' || style === 'sub') {
            // Toggle logic: If already formatted, return to normal
            const isFormatted = obj.getSelectionStyles()[0]?.fontSize < 20;
            obj.setSelectionStyles({ 
                fontSize: isFormatted ? 30 : 18, 
                deltaY: isFormatted ? 0 : (style === 'sup' ? -10 : 10) 
            });
        }
        canvas.renderAll();
    }

    function toggleTray() { document.getElementById('shape-tray').classList.toggle('visible'); }

    function addShape(type) {
        setMode('select');
        const color = colorInp.value;
        const fill = document.getElementById('fillShapes').checked ? color + '4D' : 'transparent';
        const common = { left: 200, top: container.scrollTop + 200, fill: fill, stroke: color, strokeWidth: 2 };
        let obj;
        if (type === 'rect') obj = new fabric.Rect({...common, width: 100, height: 60});
        else if (type === 'circle') obj = new fabric.Circle({...common, radius: 40});
        else if (type === 'axes') obj = new fabric.Path('M 0 100 L 0 0 M 0 0 L -5 10 M 0 0 L 5 10 M 0 100 L 100 100 M 100 100 L 90 95 M 100 100 L 90 105', {...common, fill: 'transparent'});
        else if (type === 'arrow') obj = new fabric.Path('M 0 0 L 100 0 M 100 0 L 85 -8 M 100 0 L 85 8', {...common, fill: 'transparent'});
        canvas.add(obj); document.getElementById('shape-tray').classList.remove('visible');
    }

    function addText() {
        const text = new fabric.Textbox('Text', { left: 200, top: container.scrollTop + 200, fill: colorInp.value, fontSize: 30, fontFamily: document.getElementById('fontPicker').value });
        canvas.add(text); canvas.setActiveObject(text);
    }

    function exportPDF() {
        canvas.setBackgroundColor('#f8f8f8', () => {
            const pdf = new jsPDF('p', 'px', [canvas.width, canvas.height]);
            pdf.addImage(canvas.toDataURL({format: 'png'}), 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save("whiteboard.pdf");
            canvas.setBackgroundColor(null, canvas.renderAll.bind(canvas));
        });
    }

    function clearBoard() { if(confirm("Clear?")) { canvas.clear(); history = [JSON.stringify(canvas)]; applyBrush(); } }
    colorInp.oninput = applyBrush; sizeInp.oninput = applyBrush;
    container.onscroll = () => { if(container.scrollTop + container.clientHeight > canvas.getHeight() - 800) canvas.setHeight(canvas.getHeight() + 2000); };
    
    // Initial state
    history.push(JSON.stringify(canvas));
    applyBrush();
</script>
</body>
</html>
