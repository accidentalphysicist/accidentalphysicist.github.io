<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Professional Teaching Whiteboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background: #f8f8f8; font-family: sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; overflow-y: auto; background-color: #f8f8f8; position: relative; }
        .show-grid { background-image: radial-gradient(#ccc 1px, transparent 1px); background-size: 30px 30px; }
        
        /* Whiteboard Toolbar */
        #tool-panel {
            position: fixed; left: 0; top: 50%; transform: translateY(-50%);
            width: 45px; background: white; border: 1px solid #ddd;
            border-radius: 0 10px 10px 0; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: width 0.3s; z-index: 1000; padding: 10px 5px;
            display: flex; flex-direction: column; align-items: center;
        }
        #tool-panel:hover { width: 115px; }
        .tool { font-size: 18px; margin: 4px 0; cursor: pointer; color: #666; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .tool.active, .style-btn.active { color: white; background: #4A90E2; border-color: #4A90E2; }
        
        #shape-tray {
            position: fixed; left: -250px; top: 50%; transform: translateY(-50%);
            width: 200px; background: white; border: 1px solid #ddd; border-radius: 10px;
            padding: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;
            transition: left 0.3s; z-index: 999;
        }
        #shape-tray.visible { left: 55px; }
        .shape-opt { font-size: 11px; padding: 5px; cursor: pointer; text-align: center; border: 1px solid #eee; background: #fafafa; }
        
        .text-styles { display: flex; flex-wrap: wrap; justify-content: center; gap: 2px; margin-top: 5px; }
        .style-btn { font-size: 11px; cursor: pointer; padding: 3px 6px; border: 1px solid #ddd; border-radius: 3px; background: #eee; transition: 0.2s; }
        input, select { width: 80px; margin: 4px 0; font-size: 11px; }
        .toggle-label { font-size: 11px; color: #666; text-align: center; margin: 5px 0; }

        /* --- Graphing Widget Overlay --- */
        #graph-launcher {
            position: fixed; right: 20px; top: 20px; width: 50px; height: 50px;
            background: white; border: 2px solid #4A90E2; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 2000; transition: transform 0.2s; color: #4A90E2;
        }
        #graph-launcher:hover { transform: scale(1.1); }
        
        #graph-widget {
            position: fixed; top: 7.5%; left: 7.5%; width: 85%; height: 85%;
            background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 3000; display: none; flex-direction: column; border: 1px solid #ccc;
        }
        #graph-header { background: #4A90E2; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 12px 12px 0 0; }
        #graph-body { display: flex; flex: 1; overflow: hidden; }
        
        #graph-sidebar { 
            width: 320px; 
            border-right: 1px solid #ddd; 
            padding: 20px; 
            overflow-y: auto; 
            background: #fcfcfc;
        }
        
        #chart-container { 
            flex: 1; 
            padding: 20px; 
            background: white;
            position: relative;
        }
        
        #graph-sidebar input[type="text"], #graph-sidebar input[type="number"] {
            width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; font-size: 14px;
        }

        .graph-btn { cursor: pointer; padding: 10px; border-radius: 6px; border: 1px solid #ccc; background: #fdfdfd; font-size: 13px; margin-top: 5px; width: 100%; font-weight: bold;}
        .graph-btn:hover { background: #f0f0f0; }

        #val-table-container { height: 200px; overflow-y: auto; border: 1px solid #eee; margin-top: 15px; background: white;}
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #eee; padding: 6px; text-align: center; }
        th { background: #f4f4f4; position: sticky; top: 0; }
    </style>
</head>
<body>

<div id="tool-panel">
    <div class="tool" id="select-btn" onclick="setMode('select')"><i class="fas fa-mouse-pointer"></i></div>
    <div class="tool active" id="pen-btn" onclick="setMode('pen')"><i class="fas fa-pen"></i></div>
    <div class="tool" id="pencil-btn" onclick="setMode('pencil')"><i class="fas fa-pencil-alt"></i></div>
    <div class="tool" id="marker-btn" onclick="setMode('marker')"><i class="fas fa-highlighter"></i></div>
    <div class="tool" id="eraser-btn" onclick="setMode('eraser')"><i class="fas fa-eraser"></i></div>
    <div class="tool" id="text-btn" onclick="setMode('text')"><i class="fas fa-font"></i></div>
    
    <div class="text-styles">
        <div class="style-btn" id="btn-bold" onclick="formatText('fontWeight', 'bold')">B</div>
        <div class="style-btn" id="btn-italic" onclick="formatText('fontStyle', 'italic')">I</div>
        <div class="style-btn" id="btn-underline" onclick="formatText('underline', true)">U</div>
        <div class="style-btn" id="btn-sup" onclick="formatText('super', true)">x²</div>
        <div class="style-btn" id="btn-sub" onclick="formatText('sub', true)">x₂</div>
    </div>

    <hr style="width:80%">
    <input type="color" id="colorPicker" value="#000000">
    <input type="number" id="sizePicker" value="1" min="1">
    <select id="fontPicker">
        <option value="Arial">Arial</option>
        <option value="Courier New">Mono</option>
        <option value="Times New Roman">Serif</option>
        <option value="Verdana">Verdana</option>
        <option value="Comic Sans MS">Comic</option>
    </select>
    
    <hr style="width:80%">
    <div class="tool" id="shapes-toggle" onclick="toggleTray()" style="color:#8e44ad"><i class="fas fa-shapes"></i></div>
    <div class="toggle-label"><input type="checkbox" id="fillShapes"> Fill</div>
    <div class="toggle-label"><input type="checkbox" id="gridToggle" checked onchange="toggleGrid()"> Grid</div>
    
    <hr style="width:80%">
    <div class="tool" id="pdf-btn" onclick="exportPDF()" style="color:#27ae60"><i class="fas fa-file-pdf"></i></div>
    <div class="tool" id="clear-btn" onclick="clearBoard()" style="color:#e74c3c"><i class="fas fa-trash-alt"></i></div>
</div>

<div id="shape-tray">
    <div class="shape-opt" onclick="addShape('rect')">Rect</div>
    <div class="shape-opt" onclick="addShape('circle')">Circle</div>
    <div class="shape-opt" onclick="addShape('line')">Line</div>
    <div class="shape-opt" onclick="addShape('arrow')">Arrow</div>
    <div class="shape-opt" onclick="addShape('axes')">Axes</div>
</div>

<div id="canvas-container" class="show-grid"><canvas id="c"></canvas></div>

<div id="graph-launcher" title="Open Graphing Widget" onclick="toggleGraphWidget()">
    <i class="fas fa-chart-line"></i>
</div>

<div id="graph-widget">
    <div id="graph-header">
        <strong>Graphing Calculator</strong>
        <div style="display:flex; gap:10px;">
            <button onclick="copyGraph()" style="padding:5px 10px; cursor:pointer;">Copy to Canvas</button>
            <button onclick="downloadGraph()" style="padding:5px 10px; cursor:pointer;">Download PNG</button>
            <button onclick="toggleGraphWidget()" style="background:#e74c3c; color:white; border:none; padding:5px 15px; cursor:pointer; border-radius:4px;">Close</button>
        </div>
    </div>
    
    <div id="graph-body">
        <div id="graph-sidebar">
            <input type="text" id="graphTitle" placeholder="Graph Title" oninput="syncGraph()">
            <input type="text" id="xLabel" placeholder="X-Axis Label" oninput="syncGraph()">
            <input type="text" id="yLabel" placeholder="Y-Axis Label" oninput="syncGraph()">
            <hr>
            <div id="function-list"></div>
            <button class="graph-btn" onclick="addFunctionRow()" style="background:#27ae60; color:white">+ Add Function</button>
            <hr>
            <div class="toggle-label">X-Range: <br>
                <input type="number" id="xMin" value="-10" oninput="syncGraph()" style="width:80px"> to 
                <input type="number" id="xMax" value="10" oninput="syncGraph()" style="width:80px">
            </div>
            <div class="toggle-label">Y-Range (Optional): <br>
                <input type="number" id="yMin" placeholder="Min" oninput="syncGraph()" style="width:80px"> to 
                <input type="number" id="yMax" placeholder="Max" oninput="syncGraph()" style="width:80px">
            </div>
            <div class="toggle-label">Δx (Step): <input type="number" id="deltaX" value="0.5" step="0.1" oninput="syncGraph()" style="width:80px"></div>
            <hr>
            <div id="val-table-container">
                <table id="valTable">
                    <thead><tr><th>x</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <button class="graph-btn" onclick="exportTableToCanvas()">Paste Table to Canvas</button>
            <button class="graph-btn" onclick="exportCSV()">Download CSV</button>
            <button class="graph-btn" onclick="clearGraphs()" style="background:#eee;">Reset All</button>
        </div>
        <div id="chart-container">
            <canvas id="graphCanvas"></canvas>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<script src="js/graphing.js"></script>

<script>
    const { jsPDF } = window.jspdf;
    const container = document.getElementById('canvas-container');
    // Replace your current canvas line with this:
    const canvas = new fabric.Canvas('c', { 
        width: window.innerWidth, 
        height: 4000, 
        isDrawingMode: true, 
        backgroundColor: null,
        renderOnAddRemove: false, // Optimization
        enableRetinaScaling: false, // Performance boost
        stateful: false // Stops unnecessary background checks
    });

    let currentMode = 'pen';
    const colorInp = document.getElementById('colorPicker');
    const sizeInp = document.getElementById('sizePicker');

    // Whiteboard logic remains identical to your working version...
    function formatText(property, value) {
        const obj = canvas.getActiveObject();
        if (!obj || obj.type !== 'textbox') return;
        let style = {};
        if (property === 'super' || property === 'sub') {
            const isActive = obj.getSelectionStyles()[0]?.fontSize < obj.fontSize;
            style = { fontSize: isActive ? obj.fontSize : obj.fontSize * 0.6, deltaY: isActive ? 0 : (property === 'super' ? -obj.fontSize * 0.3 : obj.fontSize * 0.3) };
        } else {
            const currentStyle = obj.getSelectionStyles()[0]?.[property] || obj[property];
            style[property] = (currentStyle === value) ? (property === 'underline' ? false : 'normal') : value;
        }
        obj.setSelectionStyles(style); canvas.renderAll();
    }

    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.tool').forEach(t => t.classList.remove('active'));
        if(document.getElementById(`${mode}-btn`)) document.getElementById(`${mode}-btn`).classList.add('active');
        canvas.isDrawingMode = (['pen', 'pencil', 'marker', 'eraser'].includes(mode));
        if (mode === 'text') addText();
        if (canvas.isDrawingMode) applyBrush();
    }

    function applyBrush() {
        canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
        const color = colorInp.value, size = parseInt(sizeInp.value);
        if (currentMode === 'pen') { canvas.freeDrawingBrush.color = color; canvas.freeDrawingBrush.width = size; }
        else if (currentMode === 'pencil') { canvas.freeDrawingBrush.color = color + '80'; canvas.freeDrawingBrush.width = size * 0.7; }
        else if (currentMode === 'marker') { canvas.freeDrawingBrush.color = color + '4D'; canvas.freeDrawingBrush.width = size * 6; canvas.freeDrawingBrush.strokeLineCap = 'square'; }
        else if (currentMode === 'eraser') { canvas.freeDrawingBrush.color = '#f8f8f8'; canvas.freeDrawingBrush.width = size * 10; }
    }

    function addText() {
        const t = new fabric.Textbox('Text', { left: 150, top: container.scrollTop + 150, fill: colorInp.value, fontSize: 30, fontFamily: document.getElementById('fontPicker').value });
        canvas.add(t); canvas.setActiveObject(t);
    }

    function toggleGrid() { container.classList.toggle('show-grid'); }
    function toggleTray() { document.getElementById('shape-tray').classList.toggle('visible'); }
    
    function addShape(type) {
        setMode('select');
        const color = colorInp.value;
        const fill = document.getElementById('fillShapes').checked ? color + '4D' : 'transparent';
        const common = { left: 150, top: container.scrollTop + 150, fill: fill, stroke: color, strokeWidth: 2 };
        let obj;
        if (type === 'rect') obj = new fabric.Rect({...common, width: 100, height: 60});
        else if (type === 'circle') obj = new fabric.Circle({...common, radius: 40});
        else if (type === 'axes') obj = new fabric.Path('M 0 100 L 0 0 M 0 0 L -5 10 M 0 0 L 5 10 M 0 100 L 100 100 M 100 100 L 90 95 M 100 100 L 90 105', {...common, fill: 'transparent'});
        else if (type === 'arrow') obj = new fabric.Path('M 0 0 L 100 0 M 100 0 L 85 -8 M 100 0 L 85 8', {...common, fill: 'transparent'});
        canvas.add(obj); document.getElementById('shape-tray').classList.remove('visible');
    }

    function exportPDF() {
        canvas.setBackgroundColor('#f8f8f8', () => {
            const pdf = new jsPDF('p', 'px', [canvas.width, canvas.height]);
            pdf.addImage(canvas.toDataURL({format: 'png'}), 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save("whiteboard.pdf");
            canvas.setBackgroundColor(null, canvas.renderAll.bind(canvas));
        });
    }

    // --- UNDO / REDO / DELETE / SHORTCUTS ---
    let history = [], redoStack = [], isResetting = false;

    function saveState() { 
        if (!isResetting) { 
            history.push(JSON.stringify(canvas)); 
            redoStack = []; 
        } 
    }

    canvas.on('object:added', saveState); 
    canvas.on('object:modified', saveState); 
    canvas.on('path:created', saveState);

    function undo() { 
        if (history.length <= 1) return; 
        isResetting = true; 
        redoStack.push(history.pop()); 
        canvas.loadFromJSON(history[history.length - 1], () => { 
            canvas.renderAll(); 
            isResetting = false; 
        }); 
    }

    function redo() { 
        if (!redoStack.length) return; 
        isResetting = true; 
        const state = redoStack.pop(); 
        history.push(state); 
        canvas.loadFromJSON(state, () => { 
            canvas.renderAll(); 
            isResetting = false; 
        }); 
    }

    // --- GLOBAL KEYBOARD LISTENER ---
    window.addEventListener('keydown', (e) => {
        const obj = canvas.getActiveObject();
        const isEditingText = obj && obj.isEditing;
        // Check if user is typing in any input field (Graphing or Whiteboard)
        const isTypingInInput = ['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName);

        // 1. Meta/Ctrl Shortcuts
        if (e.ctrlKey || e.metaKey) {
            switch (e.key.toLowerCase()) {
                case 'z':
                    e.preventDefault();
                    undo();
                    break;
                case 'y':
                    e.preventDefault();
                    redo();
                    break;
                case 'b':
                    if (isEditingText) { e.preventDefault(); formatText('fontWeight', 'bold'); }
                    break;
                case 'i':
                    if (isEditingText) { e.preventDefault(); formatText('fontStyle', 'italic'); }
                    break;
                case 'u':
                    if (isEditingText) { e.preventDefault(); formatText('underline', true); }
                    break;
                case '.': // Ctrl + . for Superscript
                    if (isEditingText) { e.preventDefault(); formatText('super', true); }
                    break;
                case ',': // Ctrl + , for Subscript
                    if (isEditingText) { e.preventDefault(); formatText('sub', true); }
                    break;
            }
        }

        // 2. Delete / Backspace Logic
        // Only delete whiteboard objects if NOT typing in an input or editing text
        if ((e.key === "Delete" || e.key === "Backspace") && obj && !isEditingText && !isTypingInInput) {
            e.preventDefault();
            canvas.remove(...canvas.getActiveObjects());
            canvas.discardActiveObject().renderAll();
        }
    });

    function clearBoard() { if(confirm("Clear?")) { canvas.clear(); history = [JSON.stringify(canvas)]; applyBrush(); } }
    colorInp.oninput = applyBrush; sizeInp.oninput = applyBrush;
    container.onscroll = () => { if(container.scrollTop + container.clientHeight > canvas.getHeight() - 800) canvas.setHeight(canvas.getHeight() + 2000); };
    
    // Initial state save
    history.push(JSON.stringify(canvas));
    applyBrush();
</script>
</body>
</html>
